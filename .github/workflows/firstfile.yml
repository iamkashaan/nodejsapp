name: CI-CD for Node.js App

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DOCKER_IMAGE: kashaankhan/kashaan-portfolio:${{ github.run_number }}

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3

      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: 📦 Install Dependencies
        run: npm install

      - name: 🧪 Run Tests (Optional)
        run: npm test || echo "No tests found"

      - name: 🛠️ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔐 Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 📤 Build and Push Docker Image
        run: |
          docker build -t $DOCKER_IMAGE .
          docker push $DOCKER_IMAGE

      - name: 📝 Update Kubernetes Deployment and Push
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
         git config --global user.name "iamkashaan"
         git config --global user.email "mohdkashaan2002.mk@gmail.com"

         DEPLOYMENT_FILE="argocd/k8s/deployment.yaml"

         if [ -f "$DEPLOYMENT_FILE" ]; then
           sed -i "s|replaceImageTag|35|g" "$DEPLOYMENT_FILE"
           git add "$DEPLOYMENT_FILE"
           git diff --cached --quiet || git commit -m "🚀 Update image to version 35"
           git push https://iamkashaan:${{ secrets.PAT_TOKEN }}@github.com/iamkashaan/nodejsapp.git HEAD:main
         else
           echo "⚠️ $DEPLOYMENT_FILE not found. Skipping image update."
         fi
